<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map View - HelpOn</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #f97316;
            --danger: #dc2626;
            --dark: #1e293b;
            --light: #f8fafc;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: #f8f9fa;
            padding-bottom: 72px;
        }

        .map-header {
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
            color: white;
        }

        .map-container {
            height: calc(100vh - 140px);
            /* Expands to fill screen between header and nav */
            position: relative;
            overflow: hidden;
            background-color: #e9ecef;
        }

        .map-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #e9ecef;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #6c757d;
        }

        .map-controls {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .map-legend {
            position: absolute;
            top: 16px;
            left: 16px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 10px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .user-pin {
            background-color: var(--primary);
        }

        .helper-pin {
            background-color: var(--secondary);
        }

        .emergency-pin {
            background-color: var(--danger);
        }

        .hospital-pin {
            background-color: #ef4444;
        }

        .police-pin {
            background-color: #2563eb;
        }

        .fire-pin {
            background-color: #f97316;
        }

        .pharmacy-pin {
            background-color: #10b981;
        }

        .map-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 16px;
            z-index: 1000;
            max-height: 25vh;
            overflow-y: auto;
        }

        .emergency-card {
            border-left: 4px solid var(--danger);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 2000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 0;
            color: #6c757d;
            text-decoration: none;
            font-size: 0.75rem;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item i {
            font-size: 1.25rem;
            margin-bottom: 4px;
        }

        .map-filter {
            background-color: white;
            border-radius: 20px;
            padding: 16px;
            margin-top: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .filter-option {
            display: flex;
            align-items: center;
            padding: 8px 0;
        }

        .map-pin {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            transform: translate(-50%, -50%);
            z-index: 500;
            cursor: pointer;
        }

        .map-pin::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: inherit;
            border-radius: 50%;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .toast-container {
            z-index: 1055;
        }

        .overlay-hidden {
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .overlay-visible {
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .filter-hidden {
            display: none;
        }

        .chip-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chip {
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .chip.btn-outline-primary {
            border-color: #cbd5f5;
            color: #1e40af;
        }

        .chip.btn-check:checked + .chip {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .marker-pulse {
            animation: pulse 1.6s infinite;
        }

        .marker-pop {
            animation: pop 0.35s ease;
        }

        @keyframes pop {
            from {
                transform: scale(0.85);
                opacity: 0.6;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.45);
            }
            70% {
                transform: scale(1.08);
                box-shadow: 0 0 0 12px rgba(220, 38, 38, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="map-header py-3">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <a href="home.html" class="btn btn-outline-light btn-sm" id="backBtn">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
                <h5 class="mb-0">Map View</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-light btn-sm" id="filterToggleBtn" title="Filter Map">
                        <i class="bi bi-layers"></i>
                    </button>
                    <button class="btn btn-light btn-sm" id="settingsBtn" title="Settings">
                        <i class="bi bi-gear"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Map Container -->
    <div class="map-container">
        <div id="leafletMap" style="height: 100%; width: 100%; z-index: 1;"></div>

        <!-- Map Controls -->
        <div class="map-controls">
            <button class="btn btn-light rounded-circle shadow-sm" id="zoomInBtn" style="width: 40px; height: 40px;"
                title="Zoom In">
                <i class="bi bi-plus-lg"></i>
            </button>
            <button class="btn btn-light rounded-circle shadow-sm" id="zoomOutBtn" style="width: 40px; height: 40px;"
                title="Zoom Out">
                <i class="bi bi-dash-lg"></i>
            </button>
            <button class="btn btn-primary rounded-circle shadow-sm" id="locateMeBtn" style="width: 40px; height: 40px;"
                title="Locate Me">
                <i class="bi bi-geo-alt"></i>
            </button>
            <button class="btn btn-warning rounded-circle shadow-sm" id="findNearbyBtn" style="width: 40px; height: 40px;"
                title="Find Nearby">
                <i class="bi bi-search"></i>
            </button>
        </div>

        <!-- Map Legend -->
        <div class="map-legend">
            <div class="legend-item">
                <div class="legend-color user-pin"></div>
                <span>You</span>
            </div>
            <div class="legend-item">
                <div class="legend-color helper-pin"></div>
                <span>Helpers</span>
            </div>
            <div class="legend-item">
                <div class="legend-color emergency-pin"></div>
                <span>Emergencies</span>
            </div>
            <div class="legend-item">
                <div class="legend-color hospital-pin"></div>
                <span>Hospital</span>
            </div>
            <div class="legend-item">
                <div class="legend-color police-pin"></div>
                <span>Police</span>
            </div>
            <div class="legend-item">
                <div class="legend-color fire-pin"></div>
                <span>Fire</span>
            </div>
            <div class="legend-item">
                <div class="legend-color pharmacy-pin"></div>
                <span>Pharmacy</span>
            </div>
        </div>

        <!-- Emergency Overlay -->
        <div class="map-overlay overlay-visible" id="emergencyOverlay">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Nearby Emergencies</h5>
                <a href="#" class="small" id="viewAllEmergencies">View All</a>
            </div>
            <div id="emergencyList"></div>
            <div class="text-center text-muted py-3 d-none" id="emergencyEmpty">
                No active requests yet.
            </div>
        </div>
    </div>

    <!-- Map Filter Options -->
    <div class="container map-filter filter-hidden" id="mapFilter">
        <h5 class="mb-3">Map Filters</h5>
        <div class="filter-option">
            <div class="form-check form-switch me-3">
                <input class="form-check-input" type="checkbox" id="helpersToggle" checked>
                <label class="form-check-label" for="helpersToggle">Show Helpers</label>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="emergenciesToggle" checked>
                <label class="form-check-label" for="emergenciesToggle">Show Emergencies</label>
            </div>
        </div>
        <div class="mt-3">
            <div class="text-muted small mb-2">Nearby Services</div>
            <div class="chip-group">
                <input class="btn-check" type="checkbox" id="hospitalsToggle" autocomplete="off">
                <label class="btn btn-outline-primary chip" for="hospitalsToggle">ðŸš‘ Hospitals</label>

                <input class="btn-check" type="checkbox" id="policeToggle" autocomplete="off">
                <label class="btn btn-outline-primary chip" for="policeToggle">ðŸ‘® Police</label>

                <input class="btn-check" type="checkbox" id="fireToggle" autocomplete="off">
                <label class="btn btn-outline-primary chip" for="fireToggle">ðŸš’ Fire</label>

                <input class="btn-check" type="checkbox" id="pharmacyToggle" autocomplete="off">
                <label class="btn btn-outline-primary chip" for="pharmacyToggle">ðŸ’Š Pharmacy</label>
            </div>
        </div>
        <div class="mt-3">
            <button class="btn btn-primary btn-sm" id="applyFiltersBtn">Apply Filters</button>
            <button class="btn btn-warning btn-sm ms-2" id="findNearbyBtnInline">Find Nearby</button>
            <button class="btn btn-outline-secondary btn-sm ms-2" id="resetFiltersBtn">Reset</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Map Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <i class="bi bi-bell me-2"></i> Emergency Notifications
                            </span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="emergencyNotifications" checked>
                            </div>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <i class="bi bi-geo-alt me-2"></i> Auto-locate
                            </span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoLocate" checked>
                            </div>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <i class="bi bi-map me-2"></i> Satellite View
                            </span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="satelliteView">
                            </div>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                                <i class="bi bi-speedometer2 me-2"></i> Traffic Data
                            </span>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="trafficData">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveSettingsBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container for Notifications -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <!-- Toasts will be added here dynamically -->
    </div>

    <!-- Bottom Navigation -->
    <nav class="navbar bottom-nav py-1">
        <div class="container">
            <div class="d-flex justify-content-around w-100">
                <a href="home.html" class="nav-item">
                    <i class="bi bi-house-door"></i>
                    <span>Home</span>
                </a>
                <a href="map.html" class="nav-item active">
                    <i class="bi bi-map-fill"></i>
                    <span>Map</span>
                </a>
                <a href="rewards.html" class="nav-item">
                    <i class="bi bi-gift"></i>
                    <span>Rewards</span>
                </a>
                <a href="inbox.html" class="nav-item">
                    <i class="bi bi-inbox"></i>
                    <span>Inbox</span>
                </a>
                <a href="profile.html" class="nav-item">
                    <i class="bi bi-person"></i>
                    <span>Profile</span>
                </a>
            </div>
        </div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const HELP_POINTS_PER_TASK = 20;
        const LOCATION_TTL_MS = 5 * 60 * 1000;
        const DEFAULT_LOCATION = { lat: 28.6139, lon: 77.2090 };
        const EMERGENCY_TTL_MS = 45 * 60 * 1000;
        const MAX_EMERGENCY_DISTANCE_KM = 10;

        function getUserKey() {
            const name = (localStorage.getItem('helpon_user_name') || '').trim().toLowerCase();
            if (name) return name.replace(/\s+/g, '_');
            const token = localStorage.getItem('helpon_token');
            return token ? token.slice(-12) : 'guest';
        }

        function getPointsStorageKey() {
            return `helpon_points_${getUserKey()}`;
        }

        function getHelpsStorageKey() {
            return `helpon_helps_${getUserKey()}`;
        }

        function getLocationStorageKey() {
            return `helpon_last_location_${getUserKey()}`;
        }

        function getPointsHistoryKey() {
            return `helpon_points_history_${getUserKey()}`;
        }

        function getAlertedSOSKey() {
            return `helpon_alerted_sos_${getUserKey()}`;
        }

        function getLastAlertTimestampKey() {
            return `helpon_last_sos_alert_${getUserKey()}`;
        }

        function loadAlertedSOS() {
            try {
                const raw = localStorage.getItem(getAlertedSOSKey());
                const list = raw ? JSON.parse(raw) : [];
                return new Set(Array.isArray(list) ? list : []);
            } catch (e) {
                return new Set();
            }
        }

        function saveAlertedSOS(alertedSet) {
            localStorage.setItem(getAlertedSOSKey(), JSON.stringify(Array.from(alertedSet)));
        }

        function loadLastAlertTimestamp() {
            const raw = localStorage.getItem(getLastAlertTimestampKey());
            const ts = parseInt(raw, 10);
            return Number.isFinite(ts) ? ts : 0;
        }

        function saveLastAlertTimestamp(ts) {
            localStorage.setItem(getLastAlertTimestampKey(), String(ts));
        }

        function loadSavedLocation() {
            try {
                const raw = localStorage.getItem(getLocationStorageKey());
                if (!raw) return null;
                const data = JSON.parse(raw);
                if (!Number.isFinite(data.lat) || !Number.isFinite(data.lon)) return null;
                return data;
            } catch (e) {
                return null;
            }
        }

        function saveLocation(lat, lon) {
            localStorage.setItem(getLocationStorageKey(), JSON.stringify({
                lat: lat,
                lon: lon,
                ts: Date.now()
            }));
        }

        function isLocationFresh(location) {
            return location && location.ts && (Date.now() - location.ts) < LOCATION_TTL_MS;
        }

        function loadUserPoints() {
            const key = getPointsStorageKey();
            const raw = localStorage.getItem(key);
            if (raw === null) {
                localStorage.setItem(key, '0');
                return 0;
            }
            const points = parseInt(raw, 10);
            return Number.isFinite(points) ? points : 0;
        }

        function saveUserPoints(points) {
            const safePoints = Math.max(0, Math.floor(points));
            localStorage.setItem(getPointsStorageKey(), String(safePoints));
            return safePoints;
        }

        function loadHelpsCount() {
            const key = getHelpsStorageKey();
            const raw = localStorage.getItem(key);
            if (raw === null) {
                localStorage.setItem(key, '0');
                return 0;
            }
            const helps = parseInt(raw, 10);
            return Number.isFinite(helps) ? helps : 0;
        }

        function saveHelpsCount(count) {
            const safeCount = Math.max(0, Math.floor(count));
            localStorage.setItem(getHelpsStorageKey(), String(safeCount));
            return safeCount;
        }

        function incrementHelpsCount() {
            const current = loadHelpsCount();
            return saveHelpsCount(current + 1);
        }

        function toRad(value) {
            return (value * Math.PI) / 180;
        }

        function getDistanceKm(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function formatDistance(km) {
            if (!Number.isFinite(km)) return '-';
            if (km < 1) return `${Math.round(km * 1000)} m`;
            return `${km.toFixed(1)} km`;
        }

        function formatTimeAgo(iso) {
            if (!iso) return 'Just now';
            const date = new Date(iso);
            if (Number.isNaN(date.getTime())) return 'Just now';
            const diffMs = Date.now() - date.getTime();
            const diffMins = Math.floor(diffMs / 60000);
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} hr ago`;
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
        }

        function buildDirectionsLink(lat, lon) {
            return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
        }

        let sosAudioContext = null;

        function playSosAlertTone() {
            try {
                const AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (!AudioCtx) return;
                if (!sosAudioContext) sosAudioContext = new AudioCtx();
                if (sosAudioContext.state === 'suspended') {
                    sosAudioContext.resume();
                }

                const oscillator = sosAudioContext.createOscillator();
                const gain = sosAudioContext.createGain();
                oscillator.type = 'sine';
                oscillator.frequency.value = 880;
                gain.gain.setValueAtTime(0.001, sosAudioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.2, sosAudioContext.currentTime + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, sosAudioContext.currentTime + 0.6);

                oscillator.connect(gain);
                gain.connect(sosAudioContext.destination);
                oscillator.start();
                oscillator.stop(sosAudioContext.currentTime + 0.65);
            } catch (e) {
                console.warn('Audio alert blocked:', e);
            }
        }

        function vibrateAlert() {
            if (navigator.vibrate) {
                navigator.vibrate([200, 120, 200]);
            }
        }

        const emergencyIconCache = {};
        const serviceIconCache = {};

        function getEmergencyMeta(type) {
            const normalized = (type || '').toLowerCase();
            if (normalized.includes('health')) {
                return { label: 'Health Emergency', color: '#dc2626', icon: 'bi-heart-pulse-fill' };
            }
            if (normalized.includes('danger') || normalized.includes('sos')) {
                return { label: "I'm in danger", color: '#f97316', icon: 'bi-exclamation-triangle-fill' };
            }
            if (normalized.includes('lost')) {
                return { label: 'Lost', color: '#0ea5e9', icon: 'bi-compass-fill' };
            }
            return { label: 'Emergency', color: '#ef4444', icon: 'bi-bell-fill' };
        }

        function getServiceMeta(category) {
            const map = {
                hospital: { label: 'Hospital', color: '#ef4444', icon: 'bi-hospital-fill' },
                police: { label: 'Police Station', color: '#2563eb', icon: 'bi-shield-shaded' },
                fire: { label: 'Fire Station', color: '#f97316', icon: 'bi-fire' },
                pharmacy: { label: 'Pharmacy', color: '#10b981', icon: 'bi-capsule' }
            };
            return map[category] || { label: 'Service', color: '#64748b', icon: 'bi-geo-alt-fill' };
        }

        function getEmergencyIcon(type) {
            const meta = getEmergencyMeta(type);
            if (emergencyIconCache[meta.label]) return emergencyIconCache[meta.label];
            const iconHtml = `
                <div class="marker-pulse" style="background:${meta.color}; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; box-shadow:0 6px 14px rgba(15,23,42,0.25);">
                    <i class="bi ${meta.icon}" style="font-size:14px;"></i>
                </div>
            `;
            const icon = L.divIcon({
                className: '',
                html: iconHtml,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            emergencyIconCache[meta.label] = icon;
            return icon;
        }

        function getServiceIcon(category) {
            const meta = getServiceMeta(category);
            if (serviceIconCache[category]) return serviceIconCache[category];
            const iconHtml = `
                <div class="marker-pop" style="background:white; width:32px; height:32px; border-radius:50%; border:2px solid ${meta.color}; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 14px rgba(15,23,42,0.18);">
                    <i class="bi ${meta.icon}" style="color:${meta.color}; font-size:16px;"></i>
                </div>
            `;
            const icon = L.divIcon({
                className: '',
                html: iconHtml,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });
            serviceIconCache[category] = icon;
            return icon;
        }

        function appendPointsHistory(points, description) {
            if (!points) return;
            const key = getPointsHistoryKey();
            let history = [];
            try {
                history = JSON.parse(localStorage.getItem(key)) || [];
            } catch (e) {
                history = [];
            }
            history.unshift({
                type: 'earned',
                description: description,
                points: points,
                date: new Date().toISOString()
            });
            localStorage.setItem(key, JSON.stringify(history.slice(0, 50)));
        }

        function awardPoints(pointsToAdd) {
            const currentPoints = loadUserPoints();
            saveUserPoints(currentPoints + pointsToAdd);
            if (pointsToAdd > 0) {
                appendPointsHistory(pointsToAdd, 'Emergency completed');
            }
        }

        // Map Manager Class
        class MapManager {
            constructor() {
                this.map = null;
                this.userMarker = null;
                this.emergencyMarkers = L.layerGroup();
                this.serviceClusters = {
                    hospital: L.markerClusterGroup({ chunkedLoading: true }),
                    police: L.markerClusterGroup({ chunkedLoading: true }),
                    fire: L.markerClusterGroup({ chunkedLoading: true }),
                    pharmacy: L.markerClusterGroup({ chunkedLoading: true })
                };
                this.currentLocation = { lat: DEFAULT_LOCATION.lat, lon: DEFAULT_LOCATION.lon };
                this.alertedEmergencies = loadAlertedSOS();
                this.lastAlertTimestamp = loadLastAlertTimestamp();
                this.initialFetch = true;
                this.isFilterVisible = false;
                this.activeEmergencyId = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.initMap();
            }

            initMap() {
                const savedLocation = loadSavedLocation();
                const initialLat = savedLocation ? savedLocation.lat : DEFAULT_LOCATION.lat;
                const initialLon = savedLocation ? savedLocation.lon : DEFAULT_LOCATION.lon;

                // Initialize map with saved or default coordinates
                this.map = L.map('leafletMap', {
                    zoomControl: false // Disable default zoom to use our custom buttons
                }).setView([initialLat, initialLon], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(this.map);

                this.map.addLayer(this.emergencyMarkers);

                this.currentLocation = { lat: initialLat, lon: initialLon };
                this.setUserMarker(initialLat, initialLon);
                this.fetchEmergencies();
                this.applyFilters({ silent: true });

                const shouldRequest = !savedLocation || !isLocationFresh(savedLocation);
                if (navigator.geolocation && shouldRequest) {
                    this.showToast('Locating your position...', 'info');
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;

                            saveLocation(lat, lon);
                            this.currentLocation = { lat, lon };
                            this.map.setView([lat, lon], 14);
                            this.setUserMarker(lat, lon);
                            this.fetchEmergencies();
                            this.showToast('Location updated! Loading nearby emergencies.', 'success');
                        },
                        (error) => {
                            console.warn("Geolocation error:", error);
                            if (savedLocation) {
                                this.showToast('Location permission denied. Using last known location.', 'warning');
                            } else {
                                this.showToast('Location permission denied. Using default map.', 'warning');
                            }
                        },
                        { enableHighAccuracy: true, timeout: 5000 }
                    );
                } else if (!navigator.geolocation && !savedLocation) {
                    this.showToast('Location not supported. Using default map.', 'warning');
                }
            }

            setUserMarker(lat, lon) {
                const userIconHtml = `<div style="background-color:#0d6efd; width:20px; height:20px; border-radius:50%; border:3px solid white; box-shadow:0 0 6px rgba(0,0,0,0.6);"></div>`;
                const userIcon = L.divIcon({
                    className: 'custom-user-icon',
                    html: userIconHtml,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                if (this.userMarker) {
                    this.userMarker.setLatLng([lat, lon]);
                } else {
                    this.userMarker = L.marker([lat, lon], { icon: userIcon, zIndexOffset: 1000 })
                        .addTo(this.map)
                        .bindPopup("<b>Your Location</b>");
                }
            }

            getSelectedServiceCategories() {
                const categories = [];
                if (document.getElementById('hospitalsToggle')?.checked) categories.push('hospital');
                if (document.getElementById('policeToggle')?.checked) categories.push('police');
                if (document.getElementById('fireToggle')?.checked) categories.push('fire');
                if (document.getElementById('pharmacyToggle')?.checked) categories.push('pharmacy');
                return categories;
            }

            clearServiceClusters() {
                Object.values(this.serviceClusters).forEach(cluster => cluster.clearLayers());
            }

            buildServiceQuery(categories, lat, lon) {
                const radius = 5000;
                const parts = [];
                if (categories.includes('hospital')) {
                    parts.push(`node["amenity"="hospital"](around:${radius},${lat},${lon});`);
                    parts.push(`node["amenity"="clinic"](around:${radius},${lat},${lon});`);
                }
                if (categories.includes('police')) {
                    parts.push(`node["amenity"="police"](around:${radius},${lat},${lon});`);
                }
                if (categories.includes('fire')) {
                    parts.push(`node["amenity"="fire_station"](around:${radius},${lat},${lon});`);
                }
                if (categories.includes('pharmacy')) {
                    parts.push(`node["amenity"="pharmacy"](around:${radius},${lat},${lon});`);
                }

                return `
                    [out:json][timeout:25];
                    (
                      ${parts.join('\n')}
                    );
                    out body;
                    >;
                    out skel qt;
                `;
            }

            async fetchServicesForSelection() {
                const categories = this.getSelectedServiceCategories();
                if (categories.length === 0) {
                    this.clearServiceClusters();
                    this.applyFilters({ silent: true });
                    this.showToast('Select a service category first.', 'info');
                    return;
                }

                this.clearServiceClusters();

                const { lat, lon } = this.currentLocation;
                const query = this.buildServiceQuery(categories, lat, lon);

                try {
                    const response = await fetch('https://overpass-api.de/api/interpreter', {
                        method: 'POST',
                        body: query
                    });
                    const data = await response.json();

                    data.elements.forEach(el => {
                        if (el.type === 'node' && el.tags) {
                            const amenity = el.tags.amenity;
                            let category = null;
                            if (amenity === 'hospital' || amenity === 'clinic') category = 'hospital';
                            if (amenity === 'police') category = 'police';
                            if (amenity === 'fire_station') category = 'fire';
                            if (amenity === 'pharmacy') category = 'pharmacy';
                            if (!category || !categories.includes(category)) return;

                            const meta = getServiceMeta(category);
                            const name = el.tags.name || meta.label;
                            const distanceKm = getDistanceKm(lat, lon, el.lat, el.lon);
                            const distanceText = formatDistance(distanceKm);
                            const directions = buildDirectionsLink(el.lat, el.lon);

                            const marker = L.marker([el.lat, el.lon], {
                                icon: getServiceIcon(category),
                                riseOnHover: true
                            }).bindPopup(`
                                <div>
                                    <strong>${name}</strong><br>
                                    <small>${meta.label} - ${distanceText} away</small><br>
                                    <a href="${directions}" target="_blank" rel="noopener">Navigate with Google Maps</a>
                                </div>
                            `);

                            this.serviceClusters[category].addLayer(marker);
                        }
                    });

                    this.applyFilters({ silent: true });
                    this.showToast('Nearby services updated.', 'success');
                } catch (error) {
                    console.error("Error fetching services", error);
                    this.showToast('Failed to load nearby services.', 'error');
                }
            }

            setupEventListeners() {
                document.getElementById('backBtn').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.goBack();
                });

                document.getElementById('filterToggleBtn').addEventListener('click', () => {
                    this.toggleFilter();
                });

                document.getElementById('settingsBtn').addEventListener('click', () => {
                    this.openSettings();
                });

                document.getElementById('zoomInBtn').addEventListener('click', () => {
                    if (this.map) this.map.zoomIn();
                });

                document.getElementById('zoomOutBtn').addEventListener('click', () => {
                    if (this.map) this.map.zoomOut();
                });

                document.getElementById('locateMeBtn').addEventListener('click', () => {
                    this.locateMe();
                });

                document.getElementById('findNearbyBtn').addEventListener('click', () => {
                    this.fetchServicesForSelection();
                });

                document.getElementById('findNearbyBtnInline').addEventListener('click', () => {
                    this.fetchServicesForSelection();
                });

                document.getElementById('applyFiltersBtn').addEventListener('click', () => {
                    this.applyFilters({ silent: true });
                });

                document.getElementById('resetFiltersBtn').addEventListener('click', () => {
                    this.resetFilters();
                });

                document.getElementById('saveSettingsBtn').addEventListener('click', () => {
                    this.saveSettings();
                });
            }

            async fetchEmergencies() {
                try {
                    const token = localStorage.getItem('helpon_token');
                    const res = await fetch('https://helpon-api.vercel.app/api/emergencies/nearby', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();

                    this.emergencyMarkers.clearLayers();
                    const list = document.getElementById('emergencyList');
                    const emptyState = document.getElementById('emergencyEmpty');
                    if (list) list.innerHTML = '';

                    const now = Date.now();
                    const emergencies = (data.emergencies || [])
                        .map(e => ({
                            ...e,
                            created_at: e.created_at || new Date().toISOString()
                        }))
                        .filter(e => {
                            const createdTime = new Date(e.created_at).getTime();
                            if (Number.isNaN(createdTime)) return false;
                            if (now - createdTime > EMERGENCY_TTL_MS) return false;
                            const distance = getDistanceKm(this.currentLocation.lat, this.currentLocation.lon, e.lat, e.lon);
                            return distance <= MAX_EMERGENCY_DISTANCE_KM;
                        })
                        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                    const newAlerts = [];
                    const missedAlerts = [];

                    emergencies.forEach(e => {
                        const distanceKm = getDistanceKm(this.currentLocation.lat, this.currentLocation.lon, e.lat, e.lon);
                        const distanceText = formatDistance(distanceKm);
                        const timeText = formatTimeAgo(e.created_at);
                        const meta = getEmergencyMeta(e.type);
                        const directions = buildDirectionsLink(e.lat, e.lon);
                        const createdTs = new Date(e.created_at).getTime();

                        if (!this.alertedEmergencies.has(e.id)) {
                            if (this.initialFetch) {
                                missedAlerts.push({ ...e, meta, distanceText, timeText });
                            } else {
                                newAlerts.push({ ...e, meta, distanceText, timeText });
                            }
                            this.alertedEmergencies.add(e.id);
                        }

                        const marker = L.marker([e.lat, e.lon], {
                            icon: getEmergencyIcon(e.type),
                            riseOnHover: true
                        });

                        const popupContent = `
                            <div class="p-1">
                                <h6 class="mb-1 fw-bold" style="color:${meta.color};">${meta.label}</h6>
                                <p class="small mb-2">${e.description || 'Emergency request'}</p>
                                <p class="small text-muted mb-2">${distanceText} away - ${timeText}</p>
                                <a class="btn btn-sm btn-outline-primary w-100 mb-2" href="${directions}" target="_blank" rel="noopener">Navigate with Google Maps</a>
                                ${e.status === 'active'
                                    ? `<button class="btn btn-sm btn-danger w-100" onclick="window.mapManagerInstance.acceptEmergency('${e.id}')">Accept Request</button>`
                                    : `<button class="btn btn-sm btn-success w-100" onclick="window.mapManagerInstance.completeEmergency('${e.id}')">Mark Completed</button>`
                                }
                            </div>
                        `;
                        marker.bindPopup(popupContent);
                        this.emergencyMarkers.addLayer(marker);

                        if (list) {
                            const card = document.createElement('div');
                            card.className = 'card emergency-card mb-2';
                            card.innerHTML = `
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <span class="badge" style="background:${meta.color};">${meta.label}</span>
                                            <p class="mb-0 mt-1">${distanceText} away - ${timeText}</p>
                                            <small class="text-muted">${e.description || 'Emergency request'}</small>
                                        </div>
                                        <div class="d-flex flex-column gap-2">
                                            <a class="btn btn-outline-primary btn-sm" href="${directions}" target="_blank" rel="noopener">Navigate</a>
                                            ${e.status === 'active'
                                                ? `<button class="btn btn-primary btn-sm" onclick="window.mapManagerInstance.acceptEmergency('${e.id}')">Assist</button>`
                                                : `<button class="btn btn-success btn-sm" onclick="window.mapManagerInstance.completeEmergency('${e.id}')">Complete</button>`
                                            }
                                        </div>
                                    </div>
                                </div>
                            `;
                            list.appendChild(card);
                        }
                    });

                    if (missedAlerts.length > 0 && this.initialFetch) {
                        const first = missedAlerts[0];
                        const extra = missedAlerts.length > 1 ? ` (+${missedAlerts.length - 1} more)` : '';
                        this.showToast(`Missed SOS alert: ${first.meta.label} - ${first.distanceText} away${extra}`, 'warning');
                        saveLastAlertTimestamp(now);
                    }

                    if (newAlerts.length > 0) {
                        newAlerts.forEach(alert => {
                            this.showToast(`Emergency nearby! ${alert.meta.label} - ${alert.distanceText} away`, 'danger');
                        });
                        playSosAlertTone();
                        vibrateAlert();
                        const focusTarget = newAlerts[0];
                        if (focusTarget) {
                            this.map.setView([focusTarget.lat, focusTarget.lon], 14, { animate: true });
                        }
                        saveLastAlertTimestamp(now);
                    }

                    saveAlertedSOS(this.alertedEmergencies);
                    this.initialFetch = false;

                    if (emptyState) {
                        emptyState.classList.toggle('d-none', emergencies.length > 0);
                    }

                    this.applyFilters({ silent: true });
                } catch (err) {
                    console.error("Failed fetching live emergencies", err);
                }

                // Poll every 15 seconds
                setTimeout(() => this.fetchEmergencies(), 15000);
            }

            async acceptEmergency(id) {
                try {
                    const token = localStorage.getItem('helpon_token');
                    const res = await fetch(`https://helpon-api.vercel.app/api/emergencies/${id}/accept`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        this.showToast('Emergency Request Accepted!', 'success');
                        this.map.closePopup();
                        this.fetchEmergencies();
                    } else {
                        const err = await res.json();
                        this.showToast(err.detail || 'Failed to accept', 'error');
                    }
                } catch (err) {
                    this.showToast('Network error', 'error');
                }
            }

            async completeEmergency(id) {
                try {
                    const token = localStorage.getItem('helpon_token');
                    const res = await fetch(`https://helpon-api.vercel.app/api/emergencies/${id}/complete`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        awardPoints(HELP_POINTS_PER_TASK);
                        incrementHelpsCount();
                        this.showToast('+20 HelpPoints Awarded! Emergency Completed.', 'success');
                        this.map.closePopup();
                        this.fetchEmergencies();
                    } else {
                        const err = await res.json();
                        this.showToast(err.detail || 'Failed to complete', 'error');
                    }
                } catch (err) {
                    this.showToast('Network error', 'error');
                }
            }

            goBack() {
                window.location.href = 'home.html';
            }

            toggleFilter() {
                const filter = document.getElementById('mapFilter');
                if (this.isFilterVisible) {
                    filter.classList.add('filter-hidden');
                } else {
                    filter.classList.remove('filter-hidden');
                }
                this.isFilterVisible = !this.isFilterVisible;
            }

            openSettings() {
                const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
                settingsModal.show();
            }

            locateMe() {
                if (navigator.geolocation && this.map) {
                    this.showToast('Locating...', 'info');
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            this.currentLocation = { lat, lon };
                            saveLocation(lat, lon);
                            this.map.setView([lat, lon], 15);
                            this.setUserMarker(lat, lon);
                            this.fetchEmergencies();
                        },
                        (error) => {
                            this.showToast('Location access denied.', 'error');
                        }
                    );
                }
            }

            applyFilters(options = {}) {
                const hospitalsToggle = document.getElementById('hospitalsToggle');
                const policeToggle = document.getElementById('policeToggle');
                const fireToggle = document.getElementById('fireToggle');
                const pharmacyToggle = document.getElementById('pharmacyToggle');
                const emergenciesToggle = document.getElementById('emergenciesToggle'); // Keep for UI feedback if wanted
                const { silent = false } = options;

                if (!this.map) return;

                const serviceToggles = {
                    hospital: hospitalsToggle,
                    police: policeToggle,
                    fire: fireToggle,
                    pharmacy: pharmacyToggle
                };

                Object.entries(serviceToggles).forEach(([category, toggle]) => {
                    const cluster = this.serviceClusters[category];
                    if (!cluster) return;
                    if (toggle && toggle.checked) {
                        if (!this.map.hasLayer(cluster)) this.map.addLayer(cluster);
                    } else {
                        if (this.map.hasLayer(cluster)) this.map.removeLayer(cluster);
                    }
                });

                if (emergenciesToggle && emergenciesToggle.checked) {
                    this.map.addLayer(this.emergencyMarkers);
                } else {
                    this.map.removeLayer(this.emergencyMarkers);
                }

                if (!silent) {
                    this.toggleFilter(); // Hide after applying
                    this.showToast('Map layers updated', 'success');
                }
            }

            resetFilters() {
                const hospitalsToggle = document.getElementById('hospitalsToggle');
                const policeToggle = document.getElementById('policeToggle');
                const fireToggle = document.getElementById('fireToggle');
                const pharmacyToggle = document.getElementById('pharmacyToggle');
                const emergenciesToggle = document.getElementById('emergenciesToggle');

                if (hospitalsToggle) hospitalsToggle.checked = false;
                if (policeToggle) policeToggle.checked = false;
                if (fireToggle) fireToggle.checked = false;
                if (pharmacyToggle) pharmacyToggle.checked = false;
                if (emergenciesToggle) emergenciesToggle.checked = true;

                this.applyFilters();
            }

            saveSettings() {
                this.showToast('Map settings saved', 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
                if (modal) modal.hide();
            }

            showToast(message, type = 'info') {
                const toastContainer = document.querySelector('.toast-container');
                const toastId = 'toast-' + Date.now();

                const toastHtml = `
                    <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">${message}</div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;

                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
                toast.show();

                toastElement.addEventListener('hidden.bs.toast', () => { toastElement.remove(); });
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            window.mapManagerInstance = new MapManager();

            // Load saved settings
            const savedSettings = localStorage.getItem('mapSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                document.getElementById('emergencyNotifications').checked = settings.emergencyNotifications;
                document.getElementById('autoLocate').checked = settings.autoLocate;
                document.getElementById('satelliteView').checked = settings.satelliteView;
                document.getElementById('trafficData').checked = settings.trafficData;

                // Apply satellite view if saved
                if (settings.satelliteView) {
                    document.getElementById('mapPlaceholder').style.backgroundColor = '#1a3d5a';
                    document.getElementById('mapPlaceholder').innerHTML = `
                        < i class="bi bi-globe fs-1 mb-2" style = "color: #adb5bd;" ></i >
                        <h4 style="color: white;">Satellite View</h4>
                        <p class="text-center" style="color: #adb5bd;">Satellite map with terrain data</p>
                    `;
                }
            }
        });
    </script>
</body>

</html>
